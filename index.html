<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rock Paper Scissors</title>

  <meta name="fc:miniapp" content='{
    "version": "1",
    "imageUrl": "https://farcaster-game.netlify.app/image.png",
    "button": {
      "title": "Play Now",
      "action": {
        "type": "launch_frame",
        "name": "RPSRewardApp",
        "url": "https://your-miniapp-url.netlify.app/",
        "splashImageUrl": "https://farcaster-game.netlify.app/splash.png",
        "splashBackgroundColor": "#00BFFF"
      }
    }
  }' />

  <style>
    body { margin:0; font-family:sans-serif; background:#00BFFF; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; text-align:center; }
    h1 { margin-bottom:20px; }
    .choice-btn { padding:10px 20px; margin:10px; font-size:1.2rem; cursor:pointer; background:white; color:#00BFFF; border:none; border-radius:5px; }
    #reward-btn { display:none; padding:12px 20px; font-size:1.2rem; cursor:pointer; background:#28a745; color:white; border:none; border-radius:5px; margin-top:15px; }
    #status { margin-top:20px; font-size:1.2rem; }
  </style>
</head>
<body>
  <h1>Rock Paper Scissors + Reward</h1>
  <div id="game">
    <button class="choice-btn" id="rock-btn">Rock ü™®</button>
    <button class="choice-btn" id="paper-btn">Paper üìÑ</button>
    <button class="choice-btn" id="scissors-btn">Scissors ‚úÇÔ∏è</button>
    <div id="status"></div>
    <button id="reward-btn">Claim 0.01 TIBBIR</button>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.0/ethers.min.js";

    const statusDiv = document.getElementById('status');
    const rewardBtn = document.getElementById('reward-btn');
    const choices = ['rock','paper','scissors'];
    let gameState = { player:null, computer:null, result:null };
    let isSdkReady = false;

    // Load contract.json
    const contractData = await fetch('contract.json').then(r => r.json());
    const provider = await sdk.wallet.getEthereumProvider();
    const signer = new ethers.providers.Web3Provider(provider).getSigner();
    const contract = new ethers.Contract(contractData.address, contractData.abi, signer);

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await sdk.actions.ready();
        isSdkReady = true;
        statusDiv.innerText = "Choose Rock, Paper or Scissors to play!";

        // Game buttons
        document.getElementById('rock-btn').addEventListener('click', () => play('rock'));
        document.getElementById('paper-btn').addEventListener('click', () => play('paper'));
        document.getElementById('scissors-btn').addEventListener('click', () => play('scissors'));

        // Reward button
        rewardBtn.addEventListener('click', claimReward);

      } catch(e) {
        statusDiv.innerText = 'SDK Initialization failed: ' + e.message;
      }
    });

    function play(playerChoice){
      if(!isSdkReady) return;

      const computerChoice = choices[Math.floor(Math.random()*3)];
      gameState.player = playerChoice;
      gameState.computer = computerChoice;

      if(playerChoice === computerChoice) gameState.result = 'tie';
      else if(
        (playerChoice==='rock' && computerChoice==='scissors') ||
        (playerChoice==='paper' && computerChoice==='rock') ||
        (playerChoice==='scissors' && computerChoice==='paper')
      ) gameState.result = 'win';
      else gameState.result = 'lose';

      statusDiv.innerText = `You chose ${playerChoice}, Computer chose ${computerChoice}. Result: ${gameState.result}!`;

      if(gameState.result==='win') rewardBtn.style.display = 'block';
      else rewardBtn.style.display = 'none';
    }

    async function claimReward(){
      if(!isSdkReady) return;
      rewardBtn.disabled = true;

      try {
        const userAddress = await signer.getAddress();
        const lastClaimed = await contract.lastClaimed(userAddress);
        const cooldown = await contract.claimCooldown();
        const now = Math.floor(Date.now() / 1000);

        if(now - lastClaimed.toNumber() < cooldown.toNumber()){
          const remaining = cooldown.toNumber() - (now - lastClaimed.toNumber());
          statusDiv.innerText = `‚è≥ Wait ${remaining} seconds before claiming again.`;
          rewardBtn.disabled = false;
          return;
        }

        const tx = await contract.claimReward();
        statusDiv.innerText = '‚è≥ Transaction submitted...';
        await tx.wait();
        statusDiv.innerText = 'üéâ Reward claimed successfully!';
        rewardBtn.style.display = 'none';
      } catch(err){
        console.error(err);
        statusDiv.innerText = '‚ùå Claim failed: ' + (err.message || err);
      } finally {
        rewardBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
