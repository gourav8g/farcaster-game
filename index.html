<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rock Paper Scissors Mini App</title>

<meta name="fc:miniapp" content='{
  "version": "1",
  "imageUrl": "https://farcaster-game.netlify.app/image.png",
  "button": {
    "title": "Play Now",
    "action": {
      "type": "launch_frame",
      "name": "RockPaperScissors",
      "url": "https://farcaster-game.netlify.app/",
      "splashImageUrl": "https://farcaster-game.netlify.app/splash.png",
      "splashBackgroundColor": "#00BFFF"
    }
  }
}' />

<style>
  body {
    margin: 0;
    background: #00BFFF;
    color: white;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    text-align: center;
  }
  .choice-btn, #claim-btn {
    padding: 10px 20px;
    margin: 10px;
    font-size: 1.2rem;
    cursor: pointer;
    background: white;
    color: #00BFFF;
    border: none;
    border-radius: 5px;
  }
  #result, #status {
    font-size: 1.5rem;
    margin-top: 20px;
  }
  #claim-btn {
    display: none;
    background: #28a745;
    color: white;
  }
</style>
</head>
<body>

<h1>Rock Paper Scissors</h1>

<div id="game">
  <button class="choice-btn" id="rock-btn">Rock 🪨</button>
  <button class="choice-btn" id="paper-btn">Paper 📄</button>
  <button class="choice-btn" id="scissors-btn">Scissors ✂️</button>
  
  <div id="result"></div>
  
  <button id="claim-btn">Claim $0.01 TIBBIR</button>
  <div id="status"></div>
</div>

<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
import contractJson from './contract.json' assert { type: 'json' };
import { ethers } from 'https://cdn.ethers.io/lib/ethers-6.13.0.esm.min.js';

let gameState = { choice: null, computerChoice: null, result: null };
let provider, contract;

const rockBtn = document.getElementById('rock-btn');
const paperBtn = document.getElementById('paper-btn');
const scissorsBtn = document.getElementById('scissors-btn');
const resultDiv = document.getElementById('result');
const claimBtn = document.getElementById('claim-btn');
const statusDiv = document.getElementById('status');

async function init() {
  await sdk.actions.ready();
  provider = await sdk.wallet.getEthereumProvider();
  const signer = new ethers.BrowserProvider(provider).getSigner();
  contract = new ethers.Contract(contractJson.address, contractJson.abi, signer);

  // Game buttons
  rockBtn.addEventListener('click', () => playGame('rock'));
  paperBtn.addEventListener('click', () => playGame('paper'));
  scissorsBtn.addEventListener('click', () => playGame('scissors'));

  // Claim button
  claimBtn.addEventListener('click', claimReward);

  checkCooldown();
}

function playGame(playerChoice) {
  gameState.choice = playerChoice;
  gameState.computerChoice = ['rock','paper','scissors'][Math.floor(Math.random()*3)];

  if(playerChoice === gameState.computerChoice) gameState.result = 'tie';
  else if(
    (playerChoice==='rock' && gameState.computerChoice==='scissors') ||
    (playerChoice==='paper' && gameState.computerChoice==='rock') ||
    (playerChoice==='scissors' && gameState.computerChoice==='paper')
  ) gameState.result = 'win';
  else gameState.result = 'lose';

  resultDiv.innerText = `You chose ${playerChoice}, Computer chose ${gameState.computerChoice}. Result: ${gameState.result}!`;

  // Show claim button only if player wins
  claimBtn.style.display = gameState.result === 'win' ? 'inline-block' : 'none';
  if(gameState.result !== 'win') statusDiv.innerText = '';
  checkCooldown();
}

async function checkCooldown() {
  try {
    const accounts = await provider.request({ method: 'eth_accounts' });
    const user = accounts[0];
    const last = await contract.lastClaimed(user);
    const cooldown = await contract.claimCooldown();
    const now = Math.floor(Date.now()/1000);

    if(now - last >= cooldown) {
      claimBtn.disabled = false;
      statusDiv.innerText = gameState.result === 'win' ? 'You can claim now!' : '';
    } else {
      claimBtn.disabled = true;
      const remaining = cooldown - (now - last);
      startTimer(remaining);
    }
  } catch(e) {
    console.error(e);
  }
}

function startTimer(seconds) {
  clearInterval(window.cooldownTimer);
  window.cooldownTimer = setInterval(() => {
    if(seconds <= 0) {
      clearInterval(window.cooldownTimer);
      statusDiv.innerText = 'You can claim now!';
      claimBtn.disabled = false;
      return;
    }
    const h = Math.floor(seconds/3600);
    const m = Math.floor((seconds%3600)/60);
    const s = seconds%60;
    statusDiv.innerText = `Next claim in ${h}h ${m}m ${s}s`;
    seconds--;
  }, 1000);
}

async function claimReward() {
  try {
    claimBtn.disabled = true;
    const tx = await contract.claimReward();
    await tx.wait();
    statusDiv.innerText = '🎉 Reward claimed! Next claim in 4h';
    startTimer(4*3600);
  } catch(e) {
    console.error(e);
    statusDiv.innerText = '❌ Claim failed: ' + (e.reason || e.message);
    checkCooldown();
  }
}

init();
</script>
</body>
</html>
